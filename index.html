<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PocketLab HTML</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #050505;
        color: #f5f5f5;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #toolbar {
        padding: 6px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #333;
        background: #0a0a0a;
        font-size: 13px;
        flex-wrap: wrap;
      }
      #toolbar button {
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #555;
        background: #f5f5f5;
        color: #111;
        cursor: pointer;
      }
      #toolbar span {
        opacity: 0.7;
        font-size: 11px;
      }
      #main {
        flex: 1;
        display: flex;
        min-height: 0;
      }
      #editor-wrap {
        width: 45%;
        min-width: 260px;
        max-width: 520px;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        background: #050505;
      }
      #editor {
        flex: 1;
        padding: 6px;
      }
      #editor textarea {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        resize: none;
        border-radius: 4px;
        border: 1px solid #444;
        background: #111;
        color: #eee;
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
        font-size: 11px;
        line-height: 1.4;
        padding: 6px;
        white-space: pre;
      }
      #preview-wrap {
        flex: 1;
        position: relative;
        background: #000;
      }
      #preview-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: #000;
      }
      #hint {
        position: absolute;
        left: 8px;
        top: 8px;
        padding: 3px 6px;
        font-size: 11px;
        background: rgba(0,0,0,0.45);
        border-radius: 4px;
        pointer-events: none;
      }
      #app.fullscreen #editor-wrap {
        display: none;
      }
      #app.fullscreen #preview-wrap {
        flex: 1;
      }
      @media (max-width: 800px) {
        #main {
          flex-direction: column;
        }
        #editor-wrap {
          width: 100%;
          max-width: none;
          height: 40%;
          border-right: none;
          border-bottom: 1px solid #333;
        }
        #preview-wrap {
          height: 60%;
        }
        #app.fullscreen #editor-wrap {
          display: none;
        }
        #app.fullscreen #preview-wrap {
          height: calc(100vh - 32px);
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="toolbar">
        <button id="run-btn">Run</button>
        <button id="clear-code-btn">Clear code</button>
        <button id="toggle-btn">Toggle editor</button>
        <span>Paste full HTML or pure JS, runs as-is</span>
      </div>
      <div id="main">
        <div id="editor-wrap">
          <div id="editor">
            <textarea id="code"></textarea>
          </div>
        </div>
        <div id="preview-wrap">
          <iframe
            id="preview-frame"
            sandbox="allow-scripts allow-same-origin"
          ></iframe>
          <div id="hint">Tap Run, then use the preview on the right / below</div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const STORAGE_KEY = "pocketlab-html-code-v1";

        const appEl        = document.getElementById("app");
        const codeEl       = document.getElementById("code");
        const runBtn       = document.getElementById("run-btn");
        const clearCodeBtn = document.getElementById("clear-code-btn");
        const toggleBtn    = document.getElementById("toggle-btn");
        const frame        = document.getElementById("preview-frame");

        function loadStored() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved && saved.trim().length > 0) {
              codeEl.value = saved;
              return;
            }
          } catch (e) {}
          // дефолтный пример: чистый JS без HTML
          codeEl.value =
`// Если вставляешь только JS:
// код будет обёрнут в минимальную HTML-страницу
// с фуллскрин канвасом <canvas id="canvas">

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let w = 0, h = 0;
function resize() {
  w = window.innerWidth;
  h = window.innerHeight;
  canvas.width = w;
  canvas.height = h;
}
window.addEventListener("resize", resize);
resize();

let t = 0;
function loop() {
  t += 0.01;
  ctx.fillStyle = "rgba(0,0,0,0.2)";
  ctx.fillRect(0, 0, w, h);

  const cx = w * 0.5;
  const cy = h * 0.5;
  const r = 40 + Math.sin(t * 2.0) * 20;

  ctx.strokeStyle = "#ffffff";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.stroke();

  requestAnimationFrame(loop);
}
loop();`;
        }

        function isHtmlLike(src) {
          return /<!doctype/i.test(src)
              || /<html[\s>]/i.test(src)
              || /<body[\s>]/i.test(src)
              || /<canvas[\s>]/i.test(src)
              || /<head[\s>]/i.test(src);
        }

        function wrapJsAsHtml(js) {
          return `<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PocketLab sketch</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
      }
      body {
        overflow: hidden;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        background: #000;
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script>
${js.replace(/<\/script>/gi, "<\\/script>")}
    </script>
  </body>
</html>`;
        }

        function run() {
          const src = codeEl.value || "";
          let html;
          if (isHtmlLike(src)) {
            html = src;
          } else {
            html = wrapJsAsHtml(src);
          }
          frame.srcdoc = html;
          try {
            localStorage.setItem(STORAGE_KEY, src);
          } catch (e) {}
        }

        function clearCode() {
          codeEl.value = "";
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {}
        }

        function toggleEditor() {
          if (appEl.classList.contains("fullscreen")) {
            appEl.classList.remove("fullscreen");
          } else {
            appEl.classList.add("fullscreen");
          }
        }

        runBtn.addEventListener("click", run);
        clearCodeBtn.addEventListener("click", clearCode);
        toggleBtn.addEventListener("click", () => {
          toggleEditor();
          // небольшая задержка на ресайз iframe
          setTimeout(() => {
            if (frame.contentWindow && frame.contentWindow.dispatchEvent) {
              frame.contentWindow.dispatchEvent(new Event("resize"));
            }
          }, 100);
        });

        loadStored();
        // опционально – сразу один раз запустить
        // run();
      })();
    </script>
  </body>
</html>
