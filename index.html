<!doctype html>
<!-- PocketLab v0.11 · dev Grisha Tsvetkov -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PocketLab HTML</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- normalize + Roboto -->
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">

    <!-- CodeMirror -->
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #050505;
        color: #f5f5f5;
        font-family: "Roboto", system-ui, -apple-system, sans-serif;
        overflow: hidden; /* чтобы не скроллился весь экран */
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* toolbar */

      #toolbar {
        padding: 6px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #333;
        background: #0a0a0a;
        font-size: 13px;
        flex-wrap: nowrap;
        overflow-x: auto;
        white-space: nowrap;
      }
      #toolbar button,
      #toolbar span {
        flex: 0 0 auto;
      }
      #toolbar button {
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #555;
        background: #f5f5f5;
        color: #111;
        cursor: pointer;
      }
      #toolbar span {
        opacity: 0.7;
        font-size: 11px;
      }

      /* layout */

      #main {
        flex: 1;
        display: flex;
        min-height: 0;
        overflow: hidden;
      }

      #editor-wrap {
        width: 45%;
        min-width: 220px;
        max-width: 60%;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        background: #000; /* фон под кодом */
        overflow: hidden;
      }
      #editor {
        flex: 1;
        padding: 6px;
        background: #000;
      }
      .CodeMirror {
        height: 100%;
        background: #000;
        color: #eee;
        font-size: 11px;
      }

      #divider {
        width: 12px;
        background: #141414;
        cursor: col-resize;
      }

      #preview-wrap {
        flex: 1;
        position: relative;
        background: #000;
        overflow: hidden;
      }
      #preview-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: #000;
      }
      #hint {
        position: absolute;
        left: 8px;
        top: 8px;
        padding: 3px 6px;
        font-size: 11px;
        background: rgba(0,0,0,0.45);
        border-radius: 4px;
        pointer-events: none;
      }
      #watermark {
        position: absolute;
        right: 8px;
        bottom: 6px;
        padding: 2px 4px;
        font-size: 9px;
        opacity: 0.45;
        color: #eee;
        pointer-events: none;
      }

      /* режимы раскладки: split / viewer */

      #app.mode-split #editor-wrap   { display: flex; }
      #app.mode-split #divider       { display: block; }
      #app.mode-split #preview-wrap  { display: block; }

      #app.mode-viewer #editor-wrap  { display: none; }
      #app.mode-viewer #divider      { display: none; }
      #app.mode-viewer #preview-wrap { display: block; }

      @media (max-width: 800px) {
        #main {
          flex-direction: column;
        }
        #editor-wrap {
          width: 100%;
          max-width: none;
          height: 40%;
          border-right: none;
          border-bottom: 1px solid #333;
        }
        #divider {
          width: 100%;
          height: 8px;
          cursor: row-resize;
        }
        #preview-wrap {
          height: 60%;
        }
        #app.mode-viewer #preview-wrap {
          height: calc(100vh - 32px);
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="mode-split">
      <div id="toolbar">
        <button id="paste-btn">paste</button>
        <button id="copy-btn">copy</button>
        <button id="clear-btn">clear</button>
        <button id="view-btn">view</button>
        <button id="run-btn">run</button>
        <button id="stop-btn">stop</button>
        <span>PocketLab v0.11 · paste HTML or JS, run as-is</span>
      </div>

      <div id="main">
        <div id="editor-wrap">
          <div id="editor">
            <textarea id="code"></textarea>
          </div>
        </div>

        <div id="divider"></div>

        <div id="preview-wrap">
          <iframe
            id="preview-frame"
            sandbox="allow-scripts"
          ></iframe>
          <div id="hint">tap run to update preview</div>
          <div id="watermark">PocketLab v0.11 · dev Grisha Tsvetkov</div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const STORAGE_KEY = "pocketlab-html-code-v5";

        const appEl       = document.getElementById("app");
        const mainEl      = document.getElementById("main");
        const codeTextarea= document.getElementById("code");
        const frame       = document.getElementById("preview-frame");
        const editorWrap  = document.getElementById("editor-wrap");
        const dividerEl   = document.getElementById("divider");

        const pasteBtn    = document.getElementById("paste-btn");
        const copyBtn     = document.getElementById("copy-btn");
        const clearBtn    = document.getElementById("clear-btn");
        const viewBtn     = document.getElementById("view-btn");
        const runBtn      = document.getElementById("run-btn");
        const stopBtn     = document.getElementById("stop-btn");

        let viewMode = "mode-split";

        // страница-оболочка для JS: только канвас, без <script>
        const JS_SHELL_HTML =
          "<!doctype html>" +
          "<html><head>" +
          "<meta charset='utf-8'>" +
          "<meta name='viewport' content='width=device-width,initial-scale=1'>" +
          "<title>PocketLab sketch</title>" +
          "<style>" +
          "html,body{margin:0;padding:0;height:100%;background:#000;}" +
          "body{overflow:hidden;}" +
          "canvas{display:block;width:100vw;height:100vh;background:#000;touch-action:none;}" +
          "</style>" +
          "</head><body>" +
          "<canvas id='canvas'></canvas>" +
          "</body></html>";

        // CodeMirror init
        const editor = CodeMirror.fromTextArea(codeTextarea, {
          lineNumbers: true,
          theme: "material-darker",
          mode: "javascript",
          tabSize: 2,
          indentUnit: 2,
          smartIndent: true
        });

        function detectModeByContent(text) {
          if (/<!doctype/i.test(text) || /<html[\s>]/i.test(text) || /<body[\s>]/i.test(text)) {
            editor.setOption("mode", "htmlmixed");
          } else {
            editor.setOption("mode", "javascript");
          }
        }

        function getCode() {
          return editor.getValue();
        }

        function setCode(text) {
          editor.setValue(text);
          detectModeByContent(text);
          editor.refresh();
        }

        function loadStored() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved && saved.trim().length > 0) {
              setCode(saved);
              return;
            }
          } catch (e) {}

          const def =
`// PocketLab v0.11 · dev Grisha Tsvetkov
// pure JS example
// this will be wrapped into full HTML with a fullscreen canvas#canvas

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let w = 0, h = 0;
function resize() {
  w = window.innerWidth;
  h = window.innerHeight;
  canvas.width = w;
  canvas.height = h;
}
window.addEventListener("resize", resize);
resize();

let t = 0;
function loop() {
  t += 0.01;
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(0, 0, w, h);

  const cx = w * 0.5;
  const cy = h * 0.5;
  const r = 40 + Math.sin(t * 2.0) * 20;

  ctx.strokeStyle = "#ffffff";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.stroke();

  requestAnimationFrame(loop);
}
loop();`;
          setCode(def);
        }

        function isHtmlLike(src) {
          return /<!doctype/i.test(src)
              || /<html[\s>]/i.test(src)
              || /<body[\s>]/i.test(src)
              || /<head[\s>]/i.test(src)
              || /<canvas[\s>]/i.test(src);
        }

        function run() {
          const src = getCode() || "";

          if (isHtmlLike(src)) {
            // если это полноценный HTML, просто подставляем
            frame.onload = null;
            frame.srcdoc = src;
          } else {
            // если это JS – грузим оболочку и после onload выполняем код внутри iframe
            frame.onload = function () {
              try {
                frame.contentWindow.eval(src);
              } catch (e) {
                console.error("PocketLab eval error:", e);
              }
            };
            frame.srcdoc = JS_SHELL_HTML;
          }

          try {
            localStorage.setItem(STORAGE_KEY, src);
          } catch (e) {}
        }

        function stop() {
          frame.onload = null;
          frame.srcdoc =
            "<!doctype html><html><head><meta charset='utf-8'><title>stopped</title></head>" +
            "<body style='margin:0;background:#000;'></body></html>";
        }

        function clearCode() {
          setCode("");
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {}
        }

        function setMode(mode) {
          appEl.classList.remove("mode-split", "mode-viewer");
          appEl.classList.add(mode);
          viewMode = mode;
