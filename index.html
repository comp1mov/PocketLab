<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PocketLab HTML</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Roboto -->
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #050505;
        color: #f5f5f5;
        font-family: "Roboto", system-ui, -apple-system, sans-serif;
      }
      #app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #toolbar {
        padding: 6px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #333;
        background: #0a0a0a;
        font-size: 13px;
        flex-wrap: nowrap;
        overflow-x: auto;
        white-space: nowrap;
      }
      #toolbar button,
      #toolbar span {
        flex: 0 0 auto;
      }
      #toolbar button {
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #555;
        background: #f5f5f5;
        color: #111;
        cursor: pointer;
      }
      #toolbar span {
        opacity: 0.7;
        font-size: 11px;
      }

      #main {
        flex: 1;
        display: flex;
        min-height: 0;
      }

      #editor-wrap {
        width: 45%;
        min-width: 220px;
        max-width: 60%;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        background: #050505;
      }
      #editor {
        flex: 1;
        padding: 6px;
      }
      #code-container {
        height: 100%;
        display: flex;
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
        font-size: 11px;
        line-height: 1.4;
      }
      #line-numbers {
        width: 3.2em;
        padding: 6px 4px;
        box-sizing: border-box;
        text-align: right;
        background: #050505;
        color: #555;
        border: 1px solid #333;
        border-right: none;
        border-radius: 4px 0 0 4px;
        overflow: hidden;
      }
      #line-numbers pre {
        margin: 0;
        font: inherit;
      }
      #editor textarea {
        flex: 1;
        box-sizing: border-box;
        resize: none;
        border-radius: 0 4px 4px 0;
        border: 1px solid #444;
        border-left: none;
        background: #000;
        color: #eee;
        font: inherit;
        padding: 6px;
        white-space: pre;
        outline: none;
      }

      #divider {
        width: 4px;
        background: #181818;
        cursor: col-resize;
      }

      #preview-wrap {
        flex: 1;
        position: relative;
        background: #000;
        overflow: hidden;
      }
      #preview-frame {
        width: 100%;
        height: 100%;
        border: none;
        background: #000;
      }
      #hint {
        position: absolute;
        left: 8px;
        top: 8px;
        padding: 3px 6px;
        font-size: 11px;
        background: rgba(0,0,0,0.45);
        border-radius: 4px;
        pointer-events: none;
      }

      /* ripple */
      .ripple {
        position: absolute;
        border-radius: 999px;
        transform: translate(-50%, -50%);
        pointer-events: none;
        background: rgba(255,255,255,0.18);
        width: 0;
        height: 0;
        opacity: 0.7;
        animation: ripple 0.6s ease-out;
      }
      @keyframes ripple {
        to {
          width: 220px;
          height: 220px;
          opacity: 0;
        }
      }

      /* режимы раскладки */
      #app.mode-split #editor-wrap   { display: flex; }
      #app.mode-split #divider       { display: block; }
      #app.mode-split #preview-wrap  { display: block; }

      #app.mode-editor #editor-wrap  {
        display: flex;
        width: 100%;
        max-width: none;
      }
      #app.mode-editor #divider      { display: none; }
      #app.mode-editor #preview-wrap { display: none; }

      #app.mode-viewer #editor-wrap  { display: none; }
      #app.mode-viewer #divider      { display: none; }
      #app.mode-viewer #preview-wrap { display: block; }

      @media (max-width: 800px) {
        #main {
          flex-direction: column;
        }
        #editor-wrap {
          width: 100%;
          max-width: none;
          height: 40%;
          border-right: none;
          border-bottom: 1px solid #333;
        }
        #divider {
          width: 100%;
          height: 6px;
          cursor: row-resize;
        }
        #preview-wrap {
          height: 60%;
        }
        #app.mode-editor #editor-wrap {
          height: calc(100vh - 32px);
        }
        #app.mode-viewer #preview-wrap {
          height: calc(100vh - 32px);
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="mode-split">
      <div id="toolbar">
        <button id="paste-btn">paste</button>
        <button id="copy-btn">copy</button>
        <button id="clear-btn">clear</button>
        <button id="view-btn">view</button>
        <button id="run-btn">run</button>
        <button id="stop-btn">stop</button>
        <span>paste full HTML or pure JS, run as-is</span>
      </div>
      <div id="main">
        <div id="editor-wrap">
          <div id="editor">
            <div id="code-container">
              <div id="line-numbers">
                <pre id="line-numbers-pre"></pre>
              </div>
              <textarea id="code"></textarea>
            </div>
          </div>
        </div>

        <div id="divider"></div>

        <div id="preview-wrap">
          <iframe
            id="preview-frame"
            sandbox="allow-scripts"
          ></iframe>
          <div id="hint">tap run to update preview</div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const STORAGE_KEY = "pocketlab-html-code-v3";

        const appEl      = document.getElementById("app");
        const mainEl     = document.getElementById("main");
        const codeEl     = document.getElementById("code");
        const frame      = document.getElementById("preview-frame");
        const editorWrap = document.getElementById("editor-wrap");
        const previewWrap = document.getElementById("preview-wrap");
        const dividerEl  = document.getElementById("divider");
        const lineNumsEl = document.getElementById("line-numbers");
        const lineNumsPre = document.getElementById("line-numbers-pre");

        const pasteBtn   = document.getElementById("paste-btn");
        const copyBtn    = document.getElementById("copy-btn");
        const clearBtn   = document.getElementById("clear-btn");
        const viewBtn    = document.getElementById("view-btn");
        const runBtn     = document.getElementById("run-btn");
        const stopBtn    = document.getElementById("stop-btn");

        const viewModes = ["mode-split", "mode-viewer", "mode-editor"];
        let viewModeIndex = 0;

        function updateLineNumbers() {
          const value = codeEl.value || "";
          const lines = value.split("\n").length || 1;
          let out = "";
          for (let i = 1; i <= lines; i++) {
            out += i + "\n";
          }
          lineNumsPre.textContent = out;
        }

        function loadStored() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved && saved.trim().length > 0) {
              codeEl.value = saved;
              updateLineNumbers();
              return;
            }
          } catch (e) {}
          // дефолтный пример: чистый JS
          codeEl.value =
`// pure JS example
// this will be wrapped into full HTML with a fullscreen canvas#canvas

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let w = 0, h = 0;
function resize() {
  w = window.innerWidth;
  h = window.innerHeight;
  canvas.width = w;
  canvas.height = h;
}
window.addEventListener("resize", resize);
resize();

let t = 0;
function loop() {
  t += 0.01;
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(0, 0, w, h);

  const cx = w * 0.5;
  const cy = h * 0.5;
  const r = 40 + Math.sin(t * 2.0) * 20;

  ctx.strokeStyle = "#ffffff";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.stroke();

  requestAnimationFrame(loop);
}
loop();`;
          updateLineNumbers();
        }

        function isHtmlLike(src) {
          return /<!doctype/i.test(src)
              || /<html[\\s>]/i.test(src)
              || /<body[\\s>]/i.test(src)
              || /<head[\\s>]/i.test(src)
              || /<canvas[\\s>]/i.test(src);
        }

        function wrapJsAsHtml(js) {
          const safeJs = js.replace(/<\/script/gi, "<\\/script");
          const parts = [
'<!doctype html>',
'<html>',
'  <head>',
'    <meta charset="utf-8">',
'    <meta name="viewport" content="width=device-width,initial-scale=1">',
'    <title>PocketLab sketch</title>',
'    <style>',
'      html, body {',
'        margin: 0;',
'        padding: 0;',
'        height: 100%;',
'        background: #000;',
'      }',
'      body {',
'        overflow: hidden;',
'      }',
'      canvas {',
'        display: block;',
'        width: 100vw;',
'        height: 100vh;',
'        background: #000;',
'        touch-action: none;',
'      }',
'    </style>',
'  </head>',
'  <body>',
'    <canvas id="canvas"></canvas>',
'    <script>',
safeJs,
'    <\\/script>',
'  </body>',
'</html>'
          ];
          return parts.join("\\n");
        }

        function run() {
          const src = codeEl.value || "";
          let html;
          if (isHtmlLike(src)) {
            html = src;
          } else {
            html = wrapJsAsHtml(src);
          }
          frame.srcdoc = html;
          try {
            localStorage.setItem(STORAGE_KEY, src);
          } catch (e) {}
        }

        function stop() {
          frame.srcdoc =
            "<!doctype html><html><head><meta charset='utf-8'><title>stopped</title></head>" +
            "<body style='margin:0;background:#000;'></body></html>";
        }

        function clearCode() {
          codeEl.value = "";
          updateLineNumbers();
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {}
        }

        function setMode(mode) {
          appEl.classList.remove("mode-split", "mode-editor", "mode-viewer");
          appEl.classList.add(mode);
          const idx = viewModes.indexOf(mode);
          viewModeIndex = idx >= 0 ? idx : 0;
        }

        // clipboard helpers
        async function pasteFromClipboard() {
          if (!navigator.clipboard || !navigator.clipboard.readText) {
            alert("clipboard not available");
            return;
          }
          try {
            const text = await navigator.clipboard.readText();
            if (text) {
              codeEl.value = text;
              updateLineNumbers();
            }
          } catch (e) {
            alert("cannot read from clipboard");
          }
        }

        async function copyToClipboard() {
          if (!navigator.clipboard || !navigator.clipboard.writeText) {
            alert("clipboard not available");
            return;
          }
          try {
            await navigator.clipboard.writeText(codeEl.value || "");
          } catch (e) {
            alert("cannot write to clipboard");
          }
        }

        // resize divider
        let isDragging = false;
        let dragPointerId = null;

        dividerEl.addEventListener("pointerdown", (e) => {
          isDragging = true;
          dragPointerId = e.pointerId;
          dividerEl.setPointerCapture(dragPointerId);
        });

        function handleDrag(e) {
          if (!isDragging) return;
          const rect = mainEl.getBoundingClientRect();
          const isMobile = window.matchMedia("(max-width: 800px)").matches;
          if (isMobile) {
            const offsetY = e.clientY - rect.top;
            const ratio = Math.min(0.8, Math.max(0.2, offsetY / rect.height));
            editorWrap.style.height = (ratio * 100) + "%";
            editorWrap.style.width = "100%";
          } else {
            const offsetX = e.clientX - rect.left;
            const ratio = Math.min(0.8, Math.max(0.2, offsetX / rect.width));
            editorWrap.style.width = (ratio * 100) + "%";
            editorWrap.style.height = "100%";
          }
        }

        function endDrag() {
          if (!isDragging) return;
          isDragging = false;
          if (dragPointerId != null) {
            try { dividerEl.releasePointerCapture(dragPointerId); } catch (e) {}
          }
          dragPointerId = null;
        }

        dividerEl.addEventListener("pointermove", handleDrag);
        dividerEl.addEventListener("pointerup", endDrag);
        dividerEl.addEventListener("pointercancel", endDrag);

        // scroll sync line numbers
        codeEl.addEventListener("scroll", () => {
          lineNumsEl.scrollTop = codeEl.scrollTop;
        });

        // ripple on preview
        previewWrap.addEventListener("pointerdown", (e) => {
          const rect = previewWrap.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const ripple = document.createElement("span");
          ripple.className = "ripple";
          ripple.style.left = x + "px";
          ripple.style.top = y + "px";
          previewWrap.appendChild(ripple);
          setTimeout(() => ripple.remove(), 650);
        });

        // events
        pasteBtn.addEventListener("click", () => {
          pasteFromClipboard();
        });

        copyBtn.addEventListener("click", () => {
          copyToClipboard();
        });

        clearBtn.addEventListener("click", () => {
          clearCode();
        });

        viewBtn.addEventListener("click", () => {
          const nextIndex = (viewModeIndex + 1) % viewModes.length;
          setMode(viewModes[nextIndex]);
        });

        runBtn.addEventListener("click", () => {
          run();
        });

        stopBtn.addEventListener("click", () => {
          stop();
        });

        codeEl.addEventListener("input", updateLineNumbers);

        // init
        loadStored();
        setMode("mode-split");
        // можно авто-ран включить, если нужно:
        // run();
      })();
    </script>
  </body>
</html>
